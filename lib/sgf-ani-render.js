// Generated by CoffeeScript 1.6.3
(function() {
  var SgfAniRender;

  SgfAniRender = (function() {
    SgfAniRender.BG_TRANSPARENT = "url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAQMAAAAlPW0iAAAAA3NCSVQICAjb4U/gAAAABlBMVEXf39////8zI3BgAAAACXBIWXMAAAsSAAALEgHS3X78AAAAFnRFWHRDcmVhdGlvbiBUaW1lADEwLzA5LzEzL23IjwAAABx0RVh0U29mdHdhcmUAQWRvYmUgRmlyZXdvcmtzIENTNui8sowAAAARSURBVAiZY/jPwIAVYRf9DwB+vw/x5A8ThgAAAABJRU5ErkJggg==)";

    SgfAniRender.ICON_PLAY = "url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAgMAAABinRfyAAAAA3NCSVQICAjb4U/gAAAADFBMVEX///8AAAAAAAAAAAD4jAJNAAAABHRSTlMARJm7ODAY0QAAAAlwSFlzAAALEgAACxIB0t1+/AAAABx0RVh0U29mdHdhcmUAQWRvYmUgRmlyZXdvcmtzIENTNui8sowAAAAWdEVYdENyZWF0aW9uIFRpbWUAMTAvMTEvMTPXucnQAAAAKklEQVQImTXMMQ4AAAjCQP8/8V2nagccyCUQJ/O3BhKJRCKRjbRIx+kDcbwHJDFPvYXLAAAAAElFTkSuQmCC)";

    SgfAniRender.ICON_PAUSE = "url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAQMAAAAlPW0iAAAAA3NCSVQICAjb4U/gAAAABlBMVEX///8AAABVwtN+AAAAAnRSTlMAuyogpzwAAAAJcEhZcwAACxIAAAsSAdLdfvwAAAAcdEVYdFNvZnR3YXJlAEFkb2JlIEZpcmV3b3JrcyBDUzbovLKMAAAAFnRFWHRDcmVhdGlvbiBUaW1lADEwLzExLzEz17nJ0AAAAA5JREFUCJlj+GPPQAoCAN6nE7EZ+6SGAAAAAElFTkSuQmCC)";

    SgfAniRender.ICON_AIM = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAA3NCSVQICAjb4U/gAAAAVFBMVEX///9jcJVNev9OevtPefRReO1SeOhTd+BXdc9Ydc1YdcladMRmb4lbdL5dc7Vec7Ffcqxecq9icZxlb49mb4lmb4dpbXlnboJsbGxsbG5rbHEiIiJyfgGzAAAAHHRSTlMAVYiIiIiIiJmZmZmZqqqqqqq7zN3d3d3/////Jrqp7AAAAAlwSFlzAAALEgAACxIB0t1+/AAAABx0RVh0U29mdHdhcmUAQWRvYmUgRmlyZXdvcmtzIENTNui8sowAAAAWdEVYdENyZWF0aW9uIFRpbWUAMTAvMTEvMTPXucnQAAAAd0lEQVQYlW2P4Q7CMAiES+t0auemVgrj/d9zo6Au0/tBcl8ulyMQUVCJHjVmHazoFzQBrmGE8Fbmcu76wtk9zFOKMaY7ewaf0fRCA9w7GLRSROjg4Mhicy7bhHaUZKB6B/DY/IPgu+N6ulXKn62ATNyW/ntu9/4CzvIHc4Ju2MsAAAAASUVORK5CYII=";

    SgfAniRender.MAX_FPS = 60;

    SgfAniRender.DEFAULT_FPS = 24;

    SgfAniRender.FILE_SIGNATURE = "SGF-asset";

    SgfAniRender.INTEGER_BYTE_LENGTH = 4;

    SgfAniRender.MAX_CANVAS_SIZE = 2048;

    SgfAniRender.MIN_CANVAS_SIZE = 256;

    SgfAniRender.BG_LIST = ["trans", "black", "white", "red", "green", "blue", "grey"];

    SgfAniRender.start = function() {
      this.ox = this.attr("x");
      this.oy = this.attr("y");
      this.animate({
        opacity: .5
      }, 500, ">");
    };

    SgfAniRender.move = function(dx, dy) {
      this.newX = this.ox + dx - 8;
      this.newY = this.oy + dy - 8;
      this.attr({
        x: this.newX,
        y: this.newY
      });
    };

    SgfAniRender.up = function() {
      this.attr({
        x: this.ox,
        y: this.oy
      });
      this.animate({
        opacity: 1
      }, 500, ">");
      if (!((this.newX != null) && (this.newY != null))) {
        return;
      }
      this.parent.setRegPoint(this.newX + 8, this.newY + 8);
      delete this.newX;
      delete this.newY;
    };

    function SgfAniRender(parentElement, url, title) {
      var amfLen, ba, err, fileSize, height, i, left, signature, top, width, yScroll, _i, _ref,
        _this = this;
      this.url = url;
      if (!((parentElement != null) && (this.url != null))) {
        console.log("[sgf-ani-render::constructor] bad arguments, parentElement:" + parentElement + ", @url={@url}");
        return;
      }
      err = null;
      try {
        ba = new BinFileReader(url);
        fileSize = ba.getFileSize();
      } catch (_error) {
        err = _error;
        this.displayError(err);
        return;
      }
      if (isNaN(fileSize) || fileSize <= 0) {
        err = "fail to read image binary";
        console.log("[sgf-ani-render::constructor] " + err);
        this.displayError(err);
        return;
      }
      signature = ba.readString(SgfAniRender.FILE_SIGNATURE.length, fileSize - SgfAniRender.FILE_SIGNATURE.length);
      if (signature !== SgfAniRender.FILE_SIGNATURE) {
        err = "invalid animation file";
        console.log("[sgf-ani-render::constructor] " + err);
        this.displayError(err);
        return;
      }
      ba.movePointer(-SgfAniRender.INTEGER_BYTE_LENGTH - SgfAniRender.FILE_SIGNATURE.length);
      amfLen = ba.readInt();
      ba.movePointer(-SgfAniRender.INTEGER_BYTE_LENGTH - amfLen);
      this.canvasWidth = ba.readShort();
      if (this.canvasWidth < SgfAniRender.MIN_CANVAS_SIZE) {
        this.canvasWidth = SgfAniRender.MIN_CANVAS_SIZE;
      }
      this.canvasHeight = ba.readShort();
      if (this.canvasHeight < SgfAniRender.MIN_CANVAS_SIZE) {
        this.canvasHeight = SgfAniRender.MIN_CANVAS_SIZE;
      }
      this.regPointX = ba.readShort();
      this.regPointY = ba.readShort();
      this.assetFrameNum = ba.readShort();
      if (this.canvasWidth > SgfAniRender.MAX_CANVAS_SIZE || this.canvasHeight > SgfAniRender.MAX_CANVAS_SIZE || this.assetFrameNum <= 0) {
        err = "bad animation attrs, canvasWidth:" + this.canvasWidth + ", @canvasHeight:" + this.canvasHeight + ", @assetFrameNum:" + this.assetFrameNum;
        console.log("[sgf-ani-render::constructor] " + err);
        this.displayError(err);
        return;
      }
      this.assetRects = [];
      this.originalRects = [];
      this.assetHight = 0;
      this.assetWidth = 0;
      yScroll = 0;
      for (i = _i = 0, _ref = this.assetFrameNum; _i < _ref; i = _i += 1) {
        left = ba.readShort();
        top = ba.readShort();
        width = ba.readShort();
        height = ba.readShort();
        this.originalRects.push({
          left: left,
          top: top,
          width: width,
          height: height
        });
        this.assetRects.push({
          left: 0,
          top: yScroll,
          width: width,
          height: height
        });
        this.assetHight += height;
        if (width > this.assetWidth) {
          this.assetWidth = width;
        }
        yScroll += height;
      }
      this.paper = Raphael(parentElement, this.canvasWidth, this.canvasHeight);
      this.elBackgrond = this.paper.rect(0, 0, this.canvasWidth, this.canvasHeight);
      this.elBackgrond.attr({
        "stroke": "#999"
      });
      this.btnBgColor = this.paper.rect(this.canvasWidth - 21, this.canvasHeight - 21, 16, 16);
      this.btnBgColor.attr({
        fill: SgfAniRender.BG_TRANSPARENT,
        stroke: "#333"
      }).click(function() {
        return _this.switchBackground();
      });
      this.setBackground();
      this.btnPlayControl = this.paper.rect(5, this.canvasHeight - 21, 16, 16);
      this.btnPlayControl.attr({
        fill: SgfAniRender.ICON_PAUSE,
        stroke: "#none"
      }).click(function() {
        return _this.togglePlay();
      });
      if (title != null) {
        this.paper.text(10, 15, String(title)).attr({
          "font-family": "arial",
          "font-size": "14",
          "text-anchor": "start",
          "fill": "#999"
        });
      }
      this.setFps();
      this.elFrame = this.paper.image(this.url, 0, 0, this.assetWidth, this.assetHight);
      this.elFrame.node.setAttribute("pointer-events", "none");
      this.setRegPoint(this.regPointX, this.regPointY);
      this.btnRegControl = this.paper.image(SgfAniRender.ICON_AIM, this.canvasWidth - 47, this.canvasHeight - 21, 16, 16).drag(SgfAniRender.move, SgfAniRender.start, SgfAniRender.up).parent = this;
      this.restart();
      return;
    }

    SgfAniRender.prototype.toggleRegLAid = function() {
      this.isShowRegAid = !this.isShowRegAid;
      if (this.isShowRegAid) {
        this.regAidH.show();
        this.regAidV.show();
      } else {
        this.regAidH.hide();
        this.regAidV.hide();
      }
    };

    SgfAniRender.prototype.switchBackground = function() {
      this.setBackground(SgfAniRender.BG_LIST[SgfAniRender.BG_LIST.indexOf(this.bgColor) + 1]);
    };

    SgfAniRender.prototype.togglePlay = function() {
      if (this.tickToPlay) {
        this.stop();
        this.btnPlayControl.attr({
          fill: SgfAniRender.ICON_PLAY
        });
      } else {
        this.play();
        this.btnPlayControl.attr({
          fill: SgfAniRender.ICON_PAUSE
        });
      }
    };

    SgfAniRender.prototype.stop = function() {
      clearTimeout(this.tickToPlay);
      this.tickToPlay = null;
    };

    SgfAniRender.prototype.restart = function() {
      this.currentFrame = -1;
      this.play();
    };

    SgfAniRender.prototype.play = function() {
      var _this = this;
      this.goto(this.currentFrame + 1);
      this.tickToPlay = setTimeout(function() {
        return _this.play();
      }, this.spf);
    };

    SgfAniRender.prototype.goto = function(num) {
      var assetLeft, assetRect, assetTop, originalRect, rectLeft, rectTop;
      num = (parseInt(num, 10) || 0) % this.assetFrameNum;
      if (num < 0) {
        num = (this.assetFrameNum + num) % this.assetFrameNum;
      }
      assetRect = this.assetRects[num];
      originalRect = this.originalRects[num];
      this.currentFrame = num;
      assetLeft = originalRect.left;
      assetTop = originalRect.top - assetRect.top;
      rectLeft = originalRect.left;
      rectTop = originalRect.top;
      this.elFrame.attr({
        x: assetLeft,
        y: assetTop,
        "clip-rect": "" + rectLeft + "," + rectTop + "," + assetRect.width + "," + assetRect.height
      });
    };

    SgfAniRender.prototype.setFps = function(val) {
      val = (parseInt(val, 10) || SgfAniRender.DEFAULT_FPS) % SgfAniRender.MAX_FPS;
      if (val < 1 || val > SgfAniRender.MAX_FPS) {
        val = SgfAniRender.DEFAULT_FPS;
      }
      this.fps = val;
      this.spf = Math.ceil(1000 / val);
    };

    SgfAniRender.prototype.setRegPoint = function(x, y) {
      this.regPointX = x;
      this.regPointY = y;
      this.regAidH = this.regAidH || this.paper.path("M0 " + y + "L" + this.canvasWidth + " " + y).attr({
        "stroke-dasharray": ". ",
        "stroke-opacity": "1",
        "stroke": "#F00"
      });
      this.regAidH.animate({
        path: "M0 " + y + "L" + this.canvasWidth + " " + y
      }, 500);
      this.regAidV = this.regAidV || this.paper.path("M" + x + " 0L" + x + " " + this.canvasHeight).attr({
        "stroke-dasharray": ". ",
        "stroke-opacity": "1",
        "stroke": "#F00"
      });
      this.regAidV.animate({
        path: "M" + x + " 0L" + x + " " + this.canvasHeight
      }, 500);
      this.isShowRegAid = true;
    };

    SgfAniRender.prototype.setBackground = function(bgColor) {
      var fill;
      bgColor = String(bgColor).toLowerCase();
      switch (bgColor) {
        case "white":
          this.bgColor = "white";
          fill = "#FFF";
          break;
        case "black":
          this.bgColor = "black";
          fill = "#000";
          break;
        case "red":
          this.bgColor = "red";
          fill = "#F00";
          break;
        case "green":
          this.bgColor = "green";
          fill = "#0F0";
          break;
        case "blue":
          this.bgColor = "blue";
          fill = "#00F";
          break;
        case "grey":
        case "gray":
          this.bgColor = "grey";
          fill = "#999";
          break;
        default:
          this.bgColor = "trans";
          fill = SgfAniRender.BG_TRANSPARENT;
      }
      this.elBackgrond.attr("fill", fill);
      this.btnBgColor.attr("fill", fill);
    };

    SgfAniRender.prototype.toString = function() {
      return "[SgfAniRender url:" + this.url + "]";
    };

    SgfAniRender.prototype.displayError = function(msg) {
      document.write("<div style='disply:block; width:256px; height:256px; background:#999; border:1px solid #f00; color:#f00'>" + msg + "</div>");
    };

    return SgfAniRender;

  })();

  window.SgfAniRender = SgfAniRender;

}).call(this);
