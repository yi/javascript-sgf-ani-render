// Generated by CoffeeScript 1.6.3
(function() {
  var SgfAniRender;

  SgfAniRender = (function() {
    SgfAniRender.BG_TRANSPARENT = "url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAQMAAAAlPW0iAAAAA3NCSVQICAjb4U/gAAAABlBMVEXf39////8zI3BgAAAACXBIWXMAAAsSAAALEgHS3X78AAAAFnRFWHRDcmVhdGlvbiBUaW1lADEwLzA5LzEzL23IjwAAABx0RVh0U29mdHdhcmUAQWRvYmUgRmlyZXdvcmtzIENTNui8sowAAAARSURBVAiZY/jPwIAVYRf9DwB+vw/x5A8ThgAAAABJRU5ErkJggg==)";

    SgfAniRender.ICON_PLAY = "url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAgMAAABinRfyAAAAA3NCSVQICAjb4U/gAAAADFBMVEX///8AAAAAAAAAAAD4jAJNAAAABHRSTlMARJm7ODAY0QAAAAlwSFlzAAALEgAACxIB0t1+/AAAABx0RVh0U29mdHdhcmUAQWRvYmUgRmlyZXdvcmtzIENTNui8sowAAAAWdEVYdENyZWF0aW9uIFRpbWUAMTAvMTEvMTPXucnQAAAAKklEQVQImTXMMQ4AAAjCQP8/8V2nagccyCUQJ/O3BhKJRCKRjbRIx+kDcbwHJDFPvYXLAAAAAElFTkSuQmCC)";

    SgfAniRender.ICON_PAUSE = "url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAQMAAAAlPW0iAAAAA3NCSVQICAjb4U/gAAAABlBMVEX///8AAABVwtN+AAAAAnRSTlMAuyogpzwAAAAJcEhZcwAACxIAAAsSAdLdfvwAAAAcdEVYdFNvZnR3YXJlAEFkb2JlIEZpcmV3b3JrcyBDUzbovLKMAAAAFnRFWHRDcmVhdGlvbiBUaW1lADEwLzExLzEz17nJ0AAAAA5JREFUCJlj+GPPQAoCAN6nE7EZ+6SGAAAAAElFTkSuQmCC)";

    SgfAniRender.ICON_AIM = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQBAMAAADt3eJSAAAAA3NCSVQICAjb4U/gAAAAGFBMVEX///8cHBwMDAwrKysXFxclJSUlJSUQEBASWjZYAAAACHRSTlMA////RKr//3XOcfIAAAAJcEhZcwAACxIAAAsSAdLdfvwAAAA8dEVYdEFMVFRhZwBUaGlzIGlzIHRoZSBpY29uIGZyb20gR2VudGxlZmFjZS5jb20gZnJlZSBpY29ucyBzZXQuINhr6MQAAAAcdEVYdFNvZnR3YXJlAEFkb2JlIEZpcmV3b3JrcyBDUzbovLKMAAAAQXRFWHREZXNjcmlwdGlvbgBUaGlzIGlzIHRoZSBpY29uIGZyb20gR2VudGxlZmFjZS5jb20gZnJlZSBpY29ucyBzZXQuIFR+b4cAAAAfdEVYdENvcHlyaWdodABST1lBTFRZIEZSRUUgTElDRU5TRSDe2YtpAAAAX0lEQVQImWNgQAIsJmgMVmNjUzAjOMQkOAAkkMKQwJIKZDAGMCQwBAJVOjoAeY4uDI6CggIMgoKCEBGXQBcGBvYAhgKGcJCuEoYClhKQOUEhKkEBYJOVlFSgdqkwIDEATgUMeYxn03gAAAAASUVORK5CYII=";

    SgfAniRender.ICON_BRUSH = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQBAMAAADt3eJSAAAAA3NCSVQICAjb4U/gAAAAGFBMVEX///8iIiIqKioYGBgYGBgcHBwYGBgMDAxAz6O/AAAACHRSTlMA///M//8RZnplY+YAAAAJcEhZcwAACxIAAAsSAdLdfvwAAAA8dEVYdEFMVFRhZwBUaGlzIGlzIHRoZSBpY29uIGZyb20gR2VudGxlZmFjZS5jb20gZnJlZSBpY29ucyBzZXQuINhr6MQAAABEdEVYdENvcHlyaWdodABDcmVhdGl2ZSBDb21tb25zIEF0dHJpYnV0aW9uIE5vbi1Db21tZXJjaWFsIE5vIERlcml2YXRpdmVze92woAAAAEF0RVh0RGVzY3JpcHRpb24AVGhpcyBpcyB0aGUgaWNvbiBmcm9tIEdlbnRsZWZhY2UuY29tIGZyZWUgaWNvbnMgc2V0LiBUfm+HAAAAHHRFWHRTb2Z0d2FyZQBBZG9iZSBGaXJld29ya3MgQ1M26LyyjAAAAG9JREFUCJljYAADdiUIzVAEZrAlsCupg+gidSOlAiAjWVBQUBwkYAhkGAAZzMKFgoJAGTbzUvPQ0DCgCvNy4xIXNwYG45IyZ3MXoFS5c0myszNIrbm7eYkZyNyUYvfiBBAjzaTEAGKhuXMC1AlgFQDpxxNswBv1gwAAAABJRU5ErkJggg==";

    SgfAniRender.MAX_FPS = 60;

    SgfAniRender.DEFAULT_FPS = 24;

    SgfAniRender.FILE_SIGNATURE = "SGF-asset";

    SgfAniRender.INTEGER_BYTE_LENGTH = 4;

    SgfAniRender.MAX_CANVAS_SIZE = 2048;

    SgfAniRender.MIN_CANVAS_SIZE = 256;

    SgfAniRender.BG_LIST = ["transparent", "black", "white", "red", "green", "blue", "grey"];

    SgfAniRender.EMPTY_OBJECT = {};

    SgfAniRender.DEFAULT_BACKGROUND = "transparent";

    SgfAniRender.start = function() {
      this.ox = this.attr("x");
      this.oy = this.attr("y");
      this.animate({
        opacity: .5
      }, 500, ">");
    };

    SgfAniRender.move = function(dx, dy) {
      this.newX = this.ox + dx - 8;
      this.newY = this.oy + dy - 8;
      this.attr({
        x: this.newX,
        y: this.newY
      });
    };

    SgfAniRender.up = function() {
      this.attr({
        x: this.ox,
        y: this.oy
      });
      this.animate({
        opacity: 1
      }, 500, ">");
      if (!((this.newX != null) && (this.newY != null))) {
        return;
      }
      this.parent.setRegPoint(this.newX + 8, this.newY + 8);
      delete this.newX;
      delete this.newY;
    };

    function SgfAniRender(parentElement, background, fixedCanvasWidth, fixedCanvasHeight) {
      var _this = this;
      this.fixedCanvasWidth = fixedCanvasWidth;
      this.fixedCanvasHeight = fixedCanvasHeight;
      if (parentElement == null) {
        throw "[sgf-ani-render::constructor] bad parentElement:" + parentElement;
        return;
      }
      this.fixedCanvasWidth = parseInt(this.fixedCanvasWidth, 10) || 0;
      if (this.fixedCanvasWidth < SgfAniRender.MIN_CANVAS_SIZE) {
        this.fixedCanvasWidth = 0;
      }
      if (this.fixedCanvasWidth > SgfAniRender.MAX_CANVAS_SIZE) {
        this.fixedCanvasWidth = SgfAniRender.MAX_CANVAS_SIZE;
      }
      this.fixedCanvasHeight = parseInt(this.fixedCanvasHeight, 10) || 0;
      if (this.fixedCanvasHeight < SgfAniRender.MIN_CANVAS_SIZE) {
        this.fixedCanvasHeight = 0;
      }
      if (this.fixedCanvasHeight > SgfAniRender.MAX_CANVAS_SIZE) {
        this.fixedCanvasHeight = SgfAniRender.MAX_CANVAS_SIZE;
      }
      this.paper = Raphael(parentElement, this.fixedCanvasWidth || SgfAniRender.MIN_CANVAS_SIZE, this.fixedCanvasHeight || SgfAniRender.MIN_CANVAS_SIZE);
      this.setBackground(background);
      this.btnBgColor = this.paper.image(SgfAniRender.ICON_BRUSH, this.paper.width - 21, this.paper.height - 21, 16, 16).click(function() {
        return _this.switchBackground();
      });
      this.btnPlayControl = this.paper.rect(5, this.paper.height - 21, 16, 16);
      this.btnPlayControl.attr({
        fill: SgfAniRender.ICON_PAUSE,
        stroke: "#none"
      }).click(function() {
        return _this.togglePlay();
      });
      this.btnRegControl = this.paper.image(SgfAniRender.ICON_AIM, this.paper.width - 47, this.paper.height - 21, 16, 16).drag(SgfAniRender.move, SgfAniRender.start, SgfAniRender.up);
      this.btnRegControl.parent = this;
    }

    SgfAniRender.prototype.load = function(url, title, fps) {
      var amfLen, ba, canvasHeight, canvasWidth, err, fileSize, height, i, left, signature, top, width, yScroll, _i, _ref;
      if (url === this.url) {
        console.log("[sgf-ani-render::load] target url already loaded. " + url);
        return;
      }
      this.url = url;
      this.displayLabel(title || "");
      this.stop();
      err = null;
      try {
        ba = new BinFileReader(url);
        fileSize = ba.getFileSize();
      } catch (_error) {
        err = _error;
        this.displayError(err);
        return;
      }
      if (isNaN(fileSize) || fileSize <= 0) {
        err = "fail to read image binary";
        console.log("[sgf-ani-render::constructor] " + err);
        this.displayError(err);
        return;
      }
      signature = ba.readString(SgfAniRender.FILE_SIGNATURE.length, fileSize - SgfAniRender.FILE_SIGNATURE.length);
      if (signature !== SgfAniRender.FILE_SIGNATURE) {
        err = "invalid animation file";
        console.log("[sgf-ani-render::constructor] " + err);
        this.displayError(err);
        return;
      }
      ba.movePointer(-SgfAniRender.INTEGER_BYTE_LENGTH - SgfAniRender.FILE_SIGNATURE.length);
      amfLen = ba.readInt();
      ba.movePointer(-SgfAniRender.INTEGER_BYTE_LENGTH - amfLen);
      canvasWidth = ba.readShort();
      if (canvasWidth < SgfAniRender.MIN_CANVAS_SIZE) {
        canvasWidth = SgfAniRender.MIN_CANVAS_SIZE;
      }
      canvasHeight = ba.readShort();
      if (canvasHeight < SgfAniRender.MIN_CANVAS_SIZE) {
        canvasHeight = SgfAniRender.MIN_CANVAS_SIZE;
      }
      this.regPointX = ba.readShort();
      this.regPointY = ba.readShort();
      this.assetFrameNum = ba.readShort();
      if (canvasWidth > SgfAniRender.MAX_CANVAS_SIZE || canvasHeight > SgfAniRender.MAX_CANVAS_SIZE || this.assetFrameNum <= 0) {
        err = "bad animation attrs, canvasWidth:" + canvasWidth + ", canvasHeight:" + canvasHeight + ", @assetFrameNum:" + this.assetFrameNum;
        console.log("[sgf-ani-render::load] " + err);
        this.displayError(err);
        return;
      }
      if (this.fixedCanvasWidth === 0 && this.fixedCanvasHeight === 0) {
        this._setCanvasSize(canvasWidth, canvasHeight);
      }
      this.assetRects = [];
      this.originalRects = [];
      this.assetHight = 0;
      this.assetWidth = 0;
      yScroll = 0;
      for (i = _i = 0, _ref = this.assetFrameNum; _i < _ref; i = _i += 1) {
        left = ba.readShort();
        top = ba.readShort();
        width = ba.readShort();
        height = ba.readShort();
        this.originalRects.push({
          left: left,
          top: top,
          width: width,
          height: height
        });
        this.assetRects.push({
          left: 0,
          top: yScroll,
          width: width,
          height: height
        });
        this.assetHight += height;
        if (width > this.assetWidth) {
          this.assetWidth = width;
        }
        yScroll += height;
      }
      this.setFps(fps);
      if (this.elFrame == null) {
        this.elFrame = this.paper.image(this.url, 0, 0, this.assetWidth, this.assetHight);
        this.elFrame.node.setAttribute("pointer-events", "none");
      } else {
        this.elFrame.attr({
          href: this.url,
          width: this.assetWidth,
          height: this.assetHight
        });
        this.elFrame.node.href.baseVal = this.url;
      }
      this.setRegPoint(this.regPointX, this.regPointY);
      this.restart();
      if (this.btnPlayControl != null) {
        this.btnPlayControl.show();
      }
      if (this.btnBgColor != null) {
        this.btnBgColor.show();
      }
      if (this.btnRegControl != null) {
        this.btnRegControl.show();
      }
      return this;
    };

    SgfAniRender.prototype.toggleRegLAid = function() {
      this.isShowRegAid = !this.isShowRegAid;
      if (this.isShowRegAid) {
        this.regAidH.show();
        this.regAidV.show();
      } else {
        this.regAidH.hide();
        this.regAidV.hide();
      }
    };

    SgfAniRender.prototype.switchBackground = function() {
      this.setBackground(SgfAniRender.BG_LIST[SgfAniRender.BG_LIST.indexOf(this.bgColor) + 1]);
    };

    SgfAniRender.prototype.togglePlay = function() {
      if (this.tickToPlay) {
        this.stop();
        this.btnPlayControl.attr({
          fill: SgfAniRender.ICON_PLAY
        });
      } else {
        this.play();
        this.btnPlayControl.attr({
          fill: SgfAniRender.ICON_PAUSE
        });
      }
    };

    SgfAniRender.prototype.stop = function() {
      if (this.tickToPlay != null) {
        clearTimeout(this.tickToPlay);
      }
      this.tickToPlay = null;
    };

    SgfAniRender.prototype.restart = function() {
      this.currentFrame = -1;
      this.play();
    };

    SgfAniRender.prototype.play = function() {
      var _this = this;
      this.goto(this.currentFrame + 1);
      this.tickToPlay = setTimeout(function() {
        return _this.play();
      }, this.spf);
    };

    SgfAniRender.prototype.goto = function(num) {
      var assetLeft, assetRect, assetTop, originalRect, rectLeft, rectTop;
      num = (parseInt(num, 10) || 0) % this.assetFrameNum;
      if (num < 0) {
        num = (this.assetFrameNum + num) % this.assetFrameNum;
      }
      assetRect = this.assetRects[num];
      originalRect = this.originalRects[num];
      this.currentFrame = num;
      assetLeft = originalRect.left;
      assetTop = originalRect.top - assetRect.top;
      rectLeft = originalRect.left;
      rectTop = originalRect.top;
      this.elFrame.attr({
        x: assetLeft,
        y: assetTop,
        "clip-rect": "" + rectLeft + "," + rectTop + "," + assetRect.width + "," + assetRect.height
      });
    };

    SgfAniRender.prototype.setFps = function(val) {
      val = (parseInt(val, 10) || SgfAniRender.DEFAULT_FPS) % SgfAniRender.MAX_FPS;
      if (val < 1 || val > SgfAniRender.MAX_FPS) {
        val = SgfAniRender.DEFAULT_FPS;
      }
      this.fps = val;
      this.spf = Math.ceil(1000 / val);
    };

    SgfAniRender.prototype.setRegPoint = function(x, y) {
      this.regPointX = x;
      this.regPointY = y;
      this.regAidH = this.regAidH || this.paper.path("M0 " + y + "L" + this.paper.width + " " + y).attr({
        "stroke-dasharray": ". ",
        "stroke-opacity": "1",
        "stroke": "#F00"
      });
      this.regAidH.animate({
        path: "M0 " + y + "L" + this.paper.width + " " + y
      }, 500);
      this.regAidV = this.regAidV || this.paper.path("M" + x + " 0L" + x + " " + this.paper.height).attr({
        "stroke-dasharray": ". ",
        "stroke-opacity": "1",
        "stroke": "#F00"
      });
      this.regAidV.animate({
        path: "M" + x + " 0L" + x + " " + this.paper.height
      }, 500);
      this.isShowRegAid = true;
    };

    SgfAniRender.prototype._setCanvasSize = function(w, h) {
      this.paper.setSize(w, h);
      if (this.elBackgrond != null) {
        this.elBackgrond.attr({
          "width": w,
          "height": h
        });
      }
      if (this.btnPlayControl) {
        this.btnPlayControl.attr({
          y: this.paper.height - 21
        });
      }
      if (this.btnBgColor != null) {
        this.btnBgColor.attr({
          x: this.paper.width - 21,
          y: this.paper.height - 21
        });
      }
      if (this.btnRegControl != null) {
        this.btnRegControl.attr({
          x: this.paper.width - 47,
          y: this.paper.height - 21
        });
      }
    };

    SgfAniRender.prototype.setBackground = function(bgColor) {
      var fill;
      bgColor = String(bgColor).toLowerCase();
      if (this.elBackgrond == null) {
        this.elBackgrond = this.paper.rect(0, 0, this.paper.width, this.paper.height);
        this.elBackgrond.attr({
          "stroke": "#999"
        });
      }
      switch (bgColor) {
        case "white":
          this.bgColor = "white";
          fill = "#FFF";
          break;
        case "black":
          this.bgColor = "black";
          fill = "#000";
          break;
        case "red":
          this.bgColor = "red";
          fill = "#F00";
          break;
        case "green":
          this.bgColor = "green";
          fill = "#0F0";
          break;
        case "blue":
          this.bgColor = "blue";
          fill = "#00F";
          break;
        case "grey":
        case "gray":
          this.bgColor = "grey";
          fill = "#999";
          break;
        default:
          this.bgColor = "transparent";
          fill = SgfAniRender.BG_TRANSPARENT;
      }
      this.elBackgrond.attr("fill", fill);
    };

    SgfAniRender.prototype.toString = function() {
      return "[SgfAniRender url:" + this.url + "]";
    };

    SgfAniRender.prototype.displayError = function(msg) {
      this.label = this.label || this.paper.text(10, 15, String(msg));
      this.label.attr({
        "font-family": "arial",
        "font-size": "14",
        "text-anchor": "start",
        "fill": "#f00",
        "text": msg
      });
      if (this.btnPlayControl != null) {
        this.btnPlayControl.hide();
      }
      if (this.btnBgColor != null) {
        this.btnBgColor.hide();
      }
      if (this.btnRegControl != null) {
        this.btnRegControl.hide();
      }
    };

    SgfAniRender.prototype.displayLabel = function(msg) {
      this.label = this.label || this.paper.text(10, 15, String(msg));
      this.label.attr({
        "font-family": "arial",
        "font-size": "14",
        "text-anchor": "start",
        "fill": "#333",
        "text": msg
      });
      this.setBackground();
    };

    return SgfAniRender;

  })();

  window.SgfAniRender = SgfAniRender;

}).call(this);
