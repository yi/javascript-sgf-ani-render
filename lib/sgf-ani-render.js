// Generated by CoffeeScript 1.6.3
(function() {
  var SgfAniRender;

  SgfAniRender = (function() {
    function SgfAniRender(parentElement, url) {
      var FILE_SIGNATURE, INTEGER_BYTE_LENGTH, MAX_CANVAS_SIZE, amfLen, ba, fileSize, height, i, left, signature, top, width, yScroll, _i, _ref;
      this.url = url;
      if (!((parentElement != null) && (this.url != null))) {
        console.log("[sgf-ani-render::constructor] bad arguments, parentElement:" + parentElement + ", @url={@url}");
        return;
      }
      FILE_SIGNATURE = "SGF-asset";
      INTEGER_BYTE_LENGTH = 4;
      MAX_CANVAS_SIZE = 2048;
      ba = new BinFileReader(url);
      fileSize = ba.getFileSize();
      if (isNaN(fileSize) || fileSize <= 0) {
        console.log("[sgf-ani-render::constructor] fail to read image binary");
        return;
      }
      signature = ba.readString(FILE_SIGNATURE.length, fileSize - FILE_SIGNATURE.length);
      if (signature !== FILE_SIGNATURE) {
        console.log("[sgf-ani-render::constructor] invalid animation file");
        return;
      }
      ba.movePointer(-INTEGER_BYTE_LENGTH - FILE_SIGNATURE.length);
      amfLen = ba.readInt();
      ba.movePointer(-INTEGER_BYTE_LENGTH - amfLen);
      this.canvasWidth = ba.readShort();
      this.canvasHeight = ba.readShort();
      this.regPointX = ba.readShort();
      this.regPointY = ba.readShort();
      this.assetFrameNum = ba.readShort();
      if (this.canvasWidth > MAX_CANVAS_SIZE || this.canvasHeight > MAX_CANVAS_SIZE || this.assetFrameNum <= 0) {
        console.log("[sgf-ani-render::constructor] bad animation attrs, canvasWidth:" + this.canvasWidth + ", @canvasHeight:" + this.canvasHeight + ", @assetFrameNum:" + this.assetFrameNum);
        return;
      }
      this.assetRects = [];
      this.originalRects = [];
      this.assetHight = 0;
      this.assetWidth = 0;
      yScroll = 0;
      for (i = _i = 0, _ref = this.assetFrameNum; _i < _ref; i = _i += 1) {
        left = ba.readShort();
        top = ba.readShort();
        width = ba.readShort();
        height = ba.readShort();
        this.originalRects.push({
          left: left,
          top: top,
          width: width,
          height: height
        });
        this.assetRects.push({
          left: 0,
          top: yScroll,
          width: width,
          height: height
        });
        this.assetHight += height;
        if (width > this.assetWidth) {
          this.assetWidth = width;
        }
        yScroll += height;
      }
      console.log(this);
      this.paper = Raphael(parentElement, this.canvasWidth, this.canvasHeight);
      this.elBackgrond = this.paper.rect(0, 0, this.canvasWidth, this.canvasHeight);
      this.elBackgrond.attr("fill", "green");
      this.elFrame = this.paper.image(this.url, 0, 0, this.assetWidth, this.assetHight);
      this.setRegPoint(this.regPointX, this.regPointY);
      this.goto(1);
      return;
    }

    SgfAniRender.prototype.goto = function(num) {
      var assetRect, originalRect;
      num = (parseInt(num, 10) || 0) % this.assetFrameNum;
      assetRect = this.assetRects[num];
      originalRect = this.originalRects[num];
      this.elFrame.attr({
        "clip-rect": "" + assetRect.left + "," + assetRect.top + "," + assetRect.width + "," + assetRect.height
      });
      this.elFrame.attr({
        x: -assetRect.left,
        y: -assetRect.top
      });
      this.elFrame.translate(-assetRect.left, -assetRect.top);
    };

    SgfAniRender.prototype.setRegPoint = function(x, y) {
      this.regPointX = x;
      this.regPointY = y;
      this.paper.path("M0 " + y + "L" + this.canvasWidth + " " + y).attr({
        "stroke-dasharray": ". ",
        "stroke-opacity": "1",
        "stroke": "#F00"
      });
      this.paper.path("M" + x + " 0L" + x + " " + this.canvasHeight).attr({
        "stroke-dasharray": ". ",
        "stroke-opacity": "1",
        "stroke": "#F00"
      });
    };

    SgfAniRender.prototype.toString = function() {
      return "[SgfAniRender url:" + this.url + "]";
    };

    return SgfAniRender;

  })();

  window.SgfAniRender = SgfAniRender;

}).call(this);
