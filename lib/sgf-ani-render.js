// Generated by CoffeeScript 1.6.3
(function() {
  var SgfAniRender;

  SgfAniRender = (function() {
    SgfAniRender.IMG_TRANSPARENT = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAQMAAAAlPW0iAAAAA3NCSVQICAjb4U/gAAAABlBMVEXf39////8zI3BgAAAACXBIWXMAAAsSAAALEgHS3X78AAAAFnRFWHRDcmVhdGlvbiBUaW1lADEwLzA5LzEzL23IjwAAABx0RVh0U29mdHdhcmUAQWRvYmUgRmlyZXdvcmtzIENTNui8sowAAAARSURBVAiZY/jPwIAVYRf9DwB+vw/x5A8ThgAAAABJRU5ErkJggg==";

    SgfAniRender.MAX_FPS = 60;

    SgfAniRender.DEFAULT_FPS = 24;

    SgfAniRender.FILE_SIGNATURE = "SGF-asset";

    SgfAniRender.INTEGER_BYTE_LENGTH = 4;

    SgfAniRender.MAX_CANVAS_SIZE = 2048;

    function SgfAniRender(parentElement, url, title, onChange) {
      var amfLen, ba, fileSize, height, i, left, signature, top, width, yScroll, _i, _ref;
      this.url = url;
      this.onChange = onChange;
      if (!((parentElement != null) && (this.url != null))) {
        console.log("[sgf-ani-render::constructor] bad arguments, parentElement:" + parentElement + ", @url={@url}");
        return;
      }
      ba = new BinFileReader(url);
      fileSize = ba.getFileSize();
      if (isNaN(fileSize) || fileSize <= 0) {
        console.log("[sgf-ani-render::constructor] fail to read image binary");
        return;
      }
      signature = ba.readString(SgfAniRender.FILE_SIGNATURE.length, fileSize - SgfAniRender.FILE_SIGNATURE.length);
      if (signature !== SgfAniRender.FILE_SIGNATURE) {
        console.log("[sgf-ani-render::constructor] invalid animation file");
        return;
      }
      ba.movePointer(-SgfAniRender.INTEGER_BYTE_LENGTH - SgfAniRender.FILE_SIGNATURE.length);
      amfLen = ba.readInt();
      ba.movePointer(-SgfAniRender.INTEGER_BYTE_LENGTH - amfLen);
      this.canvasWidth = ba.readShort();
      this.canvasHeight = ba.readShort();
      this.regPointX = ba.readShort();
      this.regPointY = ba.readShort();
      this.assetFrameNum = ba.readShort();
      if (this.canvasWidth > SgfAniRender.MAX_CANVAS_SIZE || this.canvasHeight > SgfAniRender.MAX_CANVAS_SIZE || this.assetFrameNum <= 0) {
        console.log("[sgf-ani-render::constructor] bad animation attrs, canvasWidth:" + this.canvasWidth + ", @canvasHeight:" + this.canvasHeight + ", @assetFrameNum:" + this.assetFrameNum);
        return;
      }
      this.assetRects = [];
      this.originalRects = [];
      this.assetHight = 0;
      this.assetWidth = 0;
      yScroll = 0;
      for (i = _i = 0, _ref = this.assetFrameNum; _i < _ref; i = _i += 1) {
        left = ba.readShort();
        top = ba.readShort();
        width = ba.readShort();
        height = ba.readShort();
        this.originalRects.push({
          left: left,
          top: top,
          width: width,
          height: height
        });
        this.assetRects.push({
          left: 0,
          top: yScroll,
          width: width,
          height: height
        });
        this.assetHight += height;
        if (width > this.assetWidth) {
          this.assetWidth = width;
        }
        yScroll += height;
      }
      this.paper = Raphael(parentElement, this.canvasWidth, this.canvasHeight);
      this.elBackgrond = this.paper.rect(0, 0, this.canvasWidth, this.canvasHeight);
      this.elBackgrond.attr({
        "stroke": "#999"
      });
      this.setBackground();
      if (title != null) {
        this.paper.text(10, 15, String(title)).attr({
          "font-family": "arial",
          "font-size": "14",
          "text-anchor": "start",
          "fill": "#999"
        });
      }
      this.setFps();
      this.elFrame = this.paper.image(this.url, 0, 0, this.assetWidth, this.assetHight);
      this.setRegPoint(this.regPointX, this.regPointY);
      this.restart();
      return;
    }

    SgfAniRender.prototype.togglePlay = function() {
      if (this.tickToPlay) {
        this.stop();
      } else {
        this.play();
      }
    };

    SgfAniRender.prototype.stop = function() {
      clearTimeout(this.tickToPlay);
      this.tickToPlay = null;
    };

    SgfAniRender.prototype.restart = function() {
      this.currentFrame = -1;
      this.play();
    };

    SgfAniRender.prototype.play = function() {
      var _this = this;
      this.goto(this.currentFrame + 1);
      this.tickToPlay = setTimeout(function() {
        return _this.play();
      }, this.spf);
    };

    SgfAniRender.prototype.goto = function(num) {
      var assetLeft, assetRect, assetTop, originalRect, rectLeft, rectTop;
      num = (parseInt(num, 10) || 0) % this.assetFrameNum;
      if (num < 0) {
        num = (this.assetFrameNum + num) % this.assetFrameNum;
      }
      assetRect = this.assetRects[num];
      originalRect = this.originalRects[num];
      this.currentFrame = num;
      assetLeft = originalRect.left;
      assetTop = originalRect.top - assetRect.top;
      rectLeft = originalRect.left;
      rectTop = originalRect.top;
      this.elFrame.attr({
        x: assetLeft,
        y: assetTop,
        "clip-rect": "" + rectLeft + "," + rectTop + "," + assetRect.width + "," + assetRect.height
      });
      if (this.onChange) {
        this.onChange({
          currentFrame: this.currentFrame
        });
      }
    };

    SgfAniRender.prototype.setFps = function(val) {
      val = (parseInt(val, 10) || SgfAniRender.DEFAULT_FPS) % SgfAniRender.MAX_FPS;
      if (val < 1 || val > SgfAniRender.MAX_FPS) {
        val = SgfAniRender.DEFAULT_FPS;
      }
      this.fps = val;
      this.spf = Math.ceil(1000 / val);
    };

    SgfAniRender.prototype.setRegPoint = function(x, y) {
      this.regPointX = x;
      this.regPointY = y;
      this.paper.path("M0 " + y + "L" + this.canvasWidth + " " + y).attr({
        "stroke-dasharray": ". ",
        "stroke-opacity": "1",
        "stroke": "#F00"
      });
      this.paper.path("M" + x + " 0L" + x + " " + this.canvasHeight).attr({
        "stroke-dasharray": ". ",
        "stroke-opacity": "1",
        "stroke": "#F00"
      });
    };

    SgfAniRender.prototype.setBackground = function(bgColor) {
      var fill;
      bgColor = String(bgColor).toLowerCase();
      switch (bgColor) {
        case "red":
          fill = "#F00";
          break;
        case "green":
          fill = "#0F0";
          break;
        case "blue":
          fill = "#00F";
          break;
        case "grey":
        case "gray":
          fill = "#999";
          break;
        default:
          fill = "url(" + SgfAniRender.IMG_TRANSPARENT + ")";
      }
      this.elBackgrond.attr("fill", fill);
    };

    SgfAniRender.prototype.toString = function() {
      return "[SgfAniRender url:" + this.url + "]";
    };

    return SgfAniRender;

  })();

  window.SgfAniRender = SgfAniRender;

}).call(this);
